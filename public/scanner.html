<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script src="jsQR.js"></script>
  </head>
  <body>
    <style>
      body {
        margin: 0;
      }

      #preview {
        position: absolute;
        width: 100;
        height: 50;
      }
    </style>

    <canvas id="preview"></canvas>

    <script>
      var video = document.createElement('video');
      var canvasElement = document.getElementById('preview');
      var canvas = canvasElement.getContext('2d');

      function drawLine(begin, end, color) {
        canvas.beginPath();
        canvas.moveTo(begin.x, begin.y);
        canvas.lineTo(end.x, end.y);
        canvas.lineWidth = 4;
        canvas.strokeStyle = color;
        canvas.stroke();
      }

      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }).then(function (stream) {
        video.srcObject = stream;
        video.setAttribute('playsinline', true);
        video.play();
        requestAnimationFrame(tick);
      });

      function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvasElement.width = video.videoWidth;
          canvasElement.height = video.videoHeight;
          canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
          var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
          var code = jsQR(imageData.data, imageData.width, imageData.height, {
            //inversionAttempts: 'dontInvert',
          });
          if (code) {
            drawLine(code.location.topLeftCorner, code.location.topRightCorner, '#FF3B58');
            drawLine(code.location.topRightCorner, code.location.bottomRightCorner, '#FF3B58');
            drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, '#FF3B58');
            drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, '#FF3B58');
            if (window.top) {
              window.top.postMessage(code.binaryData, window.location.origin);
            }
          }
        }
        requestAnimationFrame(tick);
      }
    </script>
  </body>
</html>
